@using CmsData.Codes
@using CmsData.View
@using UtilityExtensions
@model CmsWeb.Areas.Org.Models.OrgPeopleModel
<table class="table table-condensed table-striped not-wide grid2">
  <thead>
    <tr>
      <th>@Model.SortLink("Ck")</th>
      @if (Model.MultiSelect)
      {
        <th>@Model.SortLink("Tab")</th>
      }
      <th>
        @Model.SortLink("Name")
      </th>
      <th>
        @Model.SortLink("MemberType")
      </th>
      <th>
        @Model.SortLink("Church")<br />
        @Model.SortLink("Age") - @Model.SortLink("Bday")
      </th>
      <th>Communication</th>
      <th>@Model.SortLink("% Att.")</th>
      <th>
        <div class="btn-group">
          <button data-toggle="dropdown" class="btn dropdown-toggle">
            Dates <span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            <li class="header"> Sort By Date</li>
            <li>@Model.SortLink("Last Attended")</li>
            <li>@Model.SortLink("Join Date")</li>
            <li>@Model.SortLink("Drop Date")</li>
            <li>@Model.SortLink("Inactive Date")</li>
            @if (Model.ShowMinistryInfo)
            {
              <li>@Model.SortLink("Contact Received")</li>
              <li>@Model.SortLink("Contact Made")</li>
              <li>@Model.SortLink("Task About")</li>
              <li>@Model.SortLink("Task Assigned")</li>
            }
          </ul>
        </div>
      </th>
      <th>Tag</th>
    </tr>
  </thead>
  <tbody>
    @foreach (var p in Model.ViewList())
    {
      Model.DateShown = false;
      <tr>
        <td>
          <input type="checkbox" class="omck" value="@p.PeopleId" @(p.IsChecked == true ? "checked=checked" : "") />
        </td>
        @if (Model.MultiSelect)
        {
          <td>@p.Tab</td>
        }
        <td>
          <a href="/Person2/@p.PeopleId" class="@(p.IsDeceased == true ? "alert alert-danger" : "")">@p.Name</a>
          @if (Model.ShowAddress)
          {
            @p.AddressBlock
          }
        </td>
        <td>
          @ManageMemberLinks(p)
          @ManagePrevMemberLinks(p)
          @ManageGuestLinks(p)
          @ManageProspectLinks(p)
        </td>
        <td>
          @p.MemberStatus<br />
          @p.Age - @p.BirthDate
        </td>
        <td>
          @foreach (var ph in p.Phones)
          {
            @ph <br />
          }
          <a href="mailto:@p.EmailAddress">@p.EmailAddress</a>
        </td>
        <td>
          <a href="">@p.AttPct.ToString2("N1")%</a>
        </td>
        <td>
          @ShowDateLink(p.LastAttended, "/Organization/GotoMeetingForDate/{0}/{1}".Fmt(Model.Id, p.LastAttendedTicks), "Last")
          @ShowDate(p.Joined, "Joined")
          @ShowDate(p.Dropped, "Dropped")
          @ShowDate(p.InactiveDate, "Inactive")
          @if (Model.ShowMinistryInfo)
          {
            @ShowDateLink(p.LastContactReceivedDt, "/Contact2", p.LastContactReceivedId, "Contactee")
            @ShowDateLink(p.LastContactMadeDt, "/Contact2", p.LastContactMadeId, "Minister")
            if (User.IsInRole("Tasks"))/* || User.IsInRole("Admin"))*/
            {
              @ShowDateLink(p.TaskAboutDt, "/Task/List", p.TaskAboutId, "Needs Touch")
              @ShowDateLink(p.TaskDelegatedDt, "/Task/List", p.TaskDelegatedId, "Has Task")
            }
            else
            {
              @ShowDateLink(p.TaskAboutDt, "/Person2", p.PeopleId, "Needs Touch", "#tab-tasksabout")
              @ShowDateLink(p.TaskDelegatedDt, "/Person2", p.PeopleId, "Has Task", "#tab-tasksassigned")
            }
          }
        </td>
        <td>
          <a pid='@p.PeopleId' title="Add to/Remove from Active Tag" class="taguntag" href="#">
            @(p.HasTag == true ? "Remove" : "Add")
          </a>
        </td>
      </tr>
    }
  </tbody>
</table>

@helper DaysAgo(DateTime dt)
{
  if (dt > DateTime.Today)
  {
    return;
  }
  <span class="smallfont">@DateTime.Today.Subtract(dt).TotalDays.ToInt()</span>
}
@helper ShowDateLink(DateTime? dt, string url, int? id, string type, string extra = "")
{
  if (dt.HasValue)
  {
    if (Model.DateShown)
    {
      <br />
    }
    <a href="@url/@id@extra" target="contact">@dt.FormatDate2(type)</a>
    @DaysAgo(dt.Value)
    Model.DateShown = true;
  }
}
@helper ShowDateLink(DateTime? dt, string url, string type)
{
  if (dt.HasValue)
  {
    if (Model.DateShown)
    {
      <br />
    }
    <a href="@url" target="contact">@dt.FormatDate2(type)</a>
    @DaysAgo(dt.Value)
    Model.DateShown = true;
  }
}
@helper ShowDate(DateTime? dt, string type)
{
  if (dt.HasValue)
  {
    if (Model.DateShown)
    {
      <br />
    }
    <span>@dt.FormatDate2(type)</span>
    @DaysAgo(dt.Value)
    Model.DateShown = true;
  }
}
@helper ManageGuestLinks(OrgPerson p)
{
  if (p.GroupCode == GroupSelectCode.Guest)
  {
    <br /><a href="/Organization/Join/@Model.Id/@p.PeopleId" class="joinlink"
             confirm="Make @p.Name a Member of this Org?">
      Join Org
    </a>
    if (p.MemberType != "Prospect")
    {
      <br /><a href="/Organization/AddProspect/@Model.Id/@p.PeopleId" class="joinlink"
               confirm="Make @p.Name a Prospect of this Org?">
        Add as Prospect
      </a>
    }
    if (p.LastAttended.HasValue)
    {
      if (p.Hidden == true)
      {
        <br /><a href="/Organization/ShowVisitor/@Model.Id/@p.PeopleId/@p.LastAttended.Value.Ticks/Show" class="joinlink"
                 confirm="Show @p.Name as a Guest for this Org?">
          Show
        </a>
      }
      else
      {
        <br /><a href="/Organization/ShowVisitor/@Model.Id/@p.PeopleId/@p.LastAttended.Value.Ticks/Hide" class="joinlink"
                 confirm="Hide @p.Name as a Guest for this Org until next visit?">
          Hide
        </a>
      }
    }
  }
}

@helper ManageProspectLinks(OrgPerson p)
{
  if (p.GroupCode == GroupSelectCode.Prospect)
  {
    if (p.Hidden == true)
    {
      <br /><a href="/Organization/ShowProspect/@Model.Id/@p.PeopleId/Show" class="joinlink"
               confirm="Show @p.Name in Prospect List for this Org?">
        Show
      </a>
    }
    else
    {
      <br /><a href="/Organization/ShowProspect/@Model.Id/@p.PeopleId/Hide" class="joinlink"
               confirm="Hide @p.Name on Prospect List for this Org?">
        Hide
      </a>
    }
  }
}
@helper ManageMemberLinks(OrgPerson p)
{
  if (!(new[] {GroupSelectCode.Guest, GroupSelectCode.Previous}).Contains(p.GroupCode))
  {
    <a class="membertype" href="/OrgMemberDialog2/Display/@Model.Id/@p.PeopleId"> @p.MemberType </a>
  }
}
@helper ManagePrevMemberLinks(OrgPerson p)
{
  if (p.GroupCode == GroupSelectCode.Previous)
  {
    <a href="/TransactionHistory/@p.PeopleId/@Model.Id" target="history"> @p.MemberType </a><br/>
    <a href="/Organization/Join/@Model.Id/@p.PeopleId" class="joinlink"
             confirm="Re-Join @p.Name to this Org?">Re-Join Org</a>
  }
}



