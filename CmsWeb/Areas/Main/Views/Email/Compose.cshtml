@using System.Web.Optimization
@using CmsData
@using CmsData.Codes
@using CmsWeb.Areas.Manage.Controllers
@model CmsWeb.Areas.Main.Models.MassEmailer
@{
	ViewBag.Title = "Compose";
	Layout = "~/Views/Shared/SiteLayout.cshtml";
	int tID = ViewBag.templateID;	

	var t = from e in DbUtil.Db.Contents
			  where e.Id == tID
			  select e;
    var c = t.FirstOrDefault();
}
@section head
{
	<style>
		div.ti { position:relative; border: #0000ff dashed 1px; min-height:20px }
		div.ti:hover { background:#eeeeff; }
	    div.tiAdd { position: absolute; }
	</style>
}

@section scripts
{
    <script src="/ckeditor/ckeditor.js" type="text/javascript"></script>
    @Scripts.Render("~/bundles/edit-js")
    @Scripts.Render("~/bundles/single/compose-js")
}

<h2 style="margin-bottom:5px;">Compose Email for @Model.Count @( Model.Count != 1 ? "People" : "Person") @(Model.wantParents ? " including Parents" : "")</h2>
<font color="red"><b>NOTE:</b></font> Your recipient list will change if use another tab in your browser to visit another organization or person or run another query.<br />
<br />
<form id="SendEmail" method="post">
	@Html.Hidden("QBId")
   @Html.Hidden("Host")
   @Html.Hidden("CmsHost")
   @Html.Hidden("Count", Model.Count)
   @Html.Hidden("wantParents", Model.wantParents)
	@Html.Hidden("roleid", c.RoleID)
	<input type="hidden" name="saveid" value="@(c.TypeID == ContentTypeCode.TypeEmailTemplate ? 0 : c.Id )" />
	<input type="hidden" id="body" name="body" />
	<input type="hidden" id="name" name="name" value="@c.Name" />

	<table cellspacing="10">
	<tr>
		<td colspan="3">
			From: @Html.DropDownList("FromAddress", Model.EmailFroms())
		</td>
	</tr>
	<tr>
		<td colspan="3">
			<label>Subject:</label>
			<input name="Subject" size="75" value="@(c.TypeID == ContentTypeCode.TypeEmailTemplate ? "" : c.Title)" /> &nbsp;&nbsp; @Html.CheckBox("PublicViewable") Publicly viewable?
		</td>
	</tr>
	<tr>
		<td colspan="3">
			<div id="tempateBody">
				@Html.Raw(c.Body)
			</div>
		</td>
	</tr>
	<tr>
		<td width="33%" valign="top">
			<input type="button" id="TestSend" class="bt" value="Test (Send To Yourself)" />
		</td>
		<td width="33%" valign="top" align="center">
			<input type="button" id="SaveDraft" class="bt" savetype="@( c.TypeID == ContentTypeCode.TypeEmailTemplate ? 0 : 1 )" value="@( c.TypeID == ContentTypeCode.TypeEmailTemplate ? "Save As Draft" : "Save Current Draft" )" />
		</td>
		<td width="33%" align="right">
			<input type="button" id="Send" value="Send" class="bt" /><br />
			<br />
			@if( c.TypeID == ContentTypeCode.TypeSavedDraft ) {
				@:Keep Draft:<input type="checkbox" name="keepdraft" /><br />
			}
			@if ((User.IsInRole("ScheduleEmails") || User.IsInRole("Edit")) && System.Web.Configuration.WebConfigurationManager.AppSettings["UseEmailScheduler"] == "true")
			{ 
				@:Scheduled Date and Time (Optional)<br />
				@:(mm/dd/yy h:mm AM|PM)<br />
				@Html.TextBox("Schedule", Model.Schedule, new { style = "width:120px" })<br />
				@:<font color="red">Note</font>: Time is Central Time
			}
		</td>
	</tr>
	</table>
</form>
<!-- public ActionResult SaveDraft( int queryid, bool parents, int saveid, string newName, string subject, string body, int roleid ) -->
<div id="progress">
<h2>Working...</h2>
</div>
<div id="popupeditor">
	<form action="javascript:updateDiv()">
		<textarea id="htmleditor"></textarea>
		<input type="submit" value="Save" />
	</form>
</div>
<div id="askName" style="display:none">
	<br />
	<center>
	<b>Save Draft</b>
	<form action="javascript:void(0)" onsubmit="javascript:$('#SaveDraftButton').click()">
	<table cellspacing="10">
	<tr>
		<td align="right">FileName:</td>
		<td align="left"><input id="newName" name="newName" size="25" /></td>
	</tr>
	<tr>
		<td align="center" colspan="2">
			<input id="SaveDraftButton" type="button" class="bt" value="Submit" /> &nbsp;&nbsp; <input type="button" class="bt" onclick="$('#askName').dialog('close')" value="Cancel" />
		</td>
	</tr>
	</table>
	</form>
	</center>
	<br />
</div>