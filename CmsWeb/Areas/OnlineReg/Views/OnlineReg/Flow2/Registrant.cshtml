@model CmsWeb.Models.OnlineRegPersonModel
@using CmsWeb
@{
    var index = Model.Index();
    var selectfamily = Model.Parent.UserPeopleId.HasValue && Model.Parent.FamilyMembers().Any();
}
@if (Model.Parent.List.Count == 1 && !Model.IsNew && Model.Found != true && !Model.LoggedIn && !Model.OtherOK)
{
    <div class="form-group">
        <div class="col-sm-12">
            <a href="/OnlineReg/YesLogin" class="btn btn-default submitlink">
                Login with an Account
            </a>
        </div>
    </div>
}
@if (Model.LastItem() && !Model.Finished() && index > 0)
{
    /* Allow to Complete Registration
     * if displaying the last registrant (the one we are editing)
     * and it is not finished
     * and not the first one
     */
    @Helper.OnlineRegSubmitButtonRow("Complete Registration")
    <div class="instruct">New Registrations</div>
}
@if (!Model.ShowDisplay()) // This is a header that will show above the last unfinished item
{
    if (Model.UserSelectsOrganization()) // show a select organization dropdown
    {
        <div class="instruct">Make a Selection</div>
        <div>
            <select name="@Html.NameFor2(m => m.classid)">
                @{ var classidname = Html.NameFor2(m => m.classid); }
                @foreach (var i in Model.Parent.Classes(Model.classid))
                {
                    <option value="@i.Id" @(i.selected ? "selected=selected" : "") @(i.filled ? "disabled=disabled" : "")>@i.Text</option>
                }
            </select>
            <div>@Html.ValidationMessageFor(m => m.classid)</div>
        </div>
    }
    if (selectfamily) // show a family list because logged in and more than one in family
    {
        <h4>Select Family Member</h4>
        <div id="selectfamily" class="box">
            <table>
                @foreach (var fm in Model.Parent.FamilyMembers())
                {
                    <tr>
                        <td nowrap>
                            Choose <a href="/OnlineReg/Register/@fm.PeopleId" class="submitlink">@fm.Name</a> (@fm.Age)
                        </td>
                        <td>
                            @Html.ValidationMessage2("age-" + fm.PeopleId)
                        </td>
                    </tr>
                }
            </table>
        </div>
    }
    if (selectfamily) // indicate that the form is for a new person if logged in and not on first registrant
    {
        <h4>Or enter another non-family member here</h4>
    }
    else
    {
        if (Model.ShowDisplay())
        {
            <h4>Please fill out the form for a registrant</h4>
        }
        else
        {
            <h4>Or Help us find your profile in our database</h4>
        }
    }
}
            @* Show the registrant info, finished or not *@
            <div class="well">
                @if (!Model.ShowAddress)
                {
                    @Html.DivAlertBox(Model.NotFoundText, alerttype:"alert-info")
                }
                @Html.Partial("Flow/PersonMetaHidden", Model)

                @if (Model.ShowDisplay())
                {
                    @Html.Partial("Flow/PersonHidden", Model)
                    if (Model.OtherOK && !Model.ManageSubscriptions() && !Model.ChooseVolunteerTimes())
                    {
                        // need to store the other info too because it is complete and passes validation
                        @(Model.Parent.SupportMissionTrip
                ? Html.Partial("Flow/SupportMissionTripHidden", Model)
                : Html.Partial("Flow/OtherHidden", Model))
                    }
                }
                @if ((Model.Found == true || Model.IsNew) && !Model.Parent.ManagingSubscriptions() && !Model.IsCreateAccount())
                {
                    /* Show the Cancel link because we have either found the record or this is a new record
                     * and we're not in create account mode nor in manage subscriptions mode
                     */
                    <a href="/OnlineReg/Cancel/@index" class="close submitlink pull-right">
                        <img src="/Content/images/delete.gif" border="0" alt="cancel" title="cancel this registration" />
                    </a>
                }
                @if (Model.Finished()) // Show the finished registrant in a box
                {
                    <div class="personheader">
                        @(Model.FirstName + " " + Model.LastName)
                        <span class="blue" style="font-size: 80%">(<a class="toggle" href="#">Details</a>)</span>
                    </div>
                }
                @if (Model.ShowDisplay()) // Show finished Name/Address then Questions
                {
                    @Html.Partial("Flow2/PersonDisplay", Model)
                    if (!Model.ManageSubscriptions() && !Model.OnlinePledge())
                    {
                        if (Model.OtherOK) // Display answers to Questions
                        {
                            @(Model.Parent.SupportMissionTrip
                    ? Html.Partial("Flow2/SupportMissionTripDisplay", Model)
                    : Html.Partial("Flow2/OtherDisplay", Model))
                        }
                        else // Show Questions to ask
                        {
                            <div class="alert alert-info">
                                OK, We @(Model.IsNew ? "have your new" : "found your") record,
                                please continue below.
                            </div>
                            Model.Parent.ShowOtherInstructions = true;
                            @(Model.Parent.SupportMissionTrip
                    ? Html.Partial("Flow2/SupportMissionTrip", Model)
                    : Html.Partial("Flow2/OtherEdit", Model))
                        }
                    }
                }
                else if (!Model.Parent.IsEnded()) // Show next person to register, because still taking registrations
                {
                    if (Model.IsFamily) // Already found, display only
                    {
                        @Html.Partial("Flow2/PersonDisplay", Model)
                    }
                    else // Find or Add New Registrant
                    {
                        Model.Parent.ShowFindInstructions = true;
                        @Html.Partial("Flow2/PersonEdit", Model)
                    }
                }
            </div>
